stages:
    - lint
    - analysis

image: innobyte/magento2-gitlab-ci:7.3

lint:
    stage: lint
    tags:
        - ecommerce
    before_script:
        - mkdir tmp && mv composer.json tmp # create tmp folder to move composer.json in it
        - composer require magento/magento-coding-standard dealerdirect/phpcodesniffer-composer-installer --no-interaction # installing code sniffer and Magento2 coding standard
        - mv tmp/composer.json ./composer.json && rm -rf tmp # restore composer.json file in its previous location
    script:
        - ./vendor/bin/phpcs --ignore=*/vendor/* --standard=Magento2 . # running the code sniffer
    only:
        - master
        - merge_requests

sonarqube-check:
    stage: analysis
    tags:
        - ecommerce
    image:
        name: sonarsource/sonar-scanner-cli:latest
        entrypoint: [ "" ]
    before_script:
        - ''
    variables:
        SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
        GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
        SONAR_TOKEN: "${SONAR_TOKEN}"
        SONAR_HOST_URL: "${SONAR_HOST_URL}"
        SONAR_PROJECT_ID: "${SONAR_PROJECT_ID}"
    cache:
        key: "${CI_JOB_NAME}"
        paths:
            - .sonar/cache
    script:
        - sonar-scanner -Dsonar.qualitygate.wait=true -Dsonar.projectKey=$SONAR_PROJECT_ID -X
    only:
        - master
        - merge_requests
